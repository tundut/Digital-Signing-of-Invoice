<!DOCTYPE html>
<html>
<head>
    <title>Chi ti·∫øt h√≥a ƒë∆°n - {{ id }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/glass.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        #xmlContentPre {
            white-space: pre-wrap; /* Gi·ªØ ƒë·ªãnh d·∫°ng nh∆∞ng cho ph√©p ng·∫Øt d√≤ng */
            word-wrap: break-word;
            max-height: 70vh; /* Gi·ªõi h·∫°n chi·ªÅu cao */
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 15px;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="glass p-4">
<div id="transition-overlay"></div>

<div class="container container-narrow">
    <h4 class="mb-3 title-quiet"><i class="bi bi-file-earmark-text"></i> Chi ti·∫øt H√≥a ƒë∆°n K√Ω s·ªë</h4>

    <div class="panel-glass p-4 mb-3">
            <p class="mb-1"><strong>ID H√≥a ƒë∆°n:</strong> <code class="text-secondary">{{ id }}</code></p>
            <p class="mb-0"><strong>Th·ªùi gian t·∫°o:</strong> <span class="badge bg-light text-dark">{{ invoice.created_at }}</span></p>
            
            <hr class="hr-faint">
            
            <p class="mb-0"><strong>Tr·∫°ng th√°i K√Ω:</strong>
                {% if invoice.status == "valid" %}
                    <span class="badge bg-success py-2"><i class="bi bi-check-circle-fill"></i> H·ª£p l·ªá</span>
                {% else %}
                    <span class="badge bg-danger py-2"><i class="bi bi-x-octagon-fill"></i> Kh√¥ng h·ª£p l·ªá</span>
                {% endif %}
            </p>
            <p class="mt-2"><strong>Tr·∫°ng th√°i x√°c th·ª±c:</strong>
            {% if invoice.verification_status == "PENDING" %}
                <span class="badge bg-warning py-2"><i class="bi bi-exclamation-circle-fill"></i> Ch·ªù x√°c th·ª±c</span></span>
            {% elif invoice.verification_status == "VERIFIED" %}
                <span class="badge bg-success py-2"><i class="bi bi-check-circle-fill"></i> ƒê√£ ch·∫•p nh·∫≠n</span></span>
            {% else %}
                <span class="badge bg-danger py-2"><i class="bi bi-x-circle-fill"></i> B·ªã t·ª´ ch·ªëi</span></span>
            {% endif %}
            </p>
            <p class="mt-2"><strong>Th√¥ng b√°o x√°c th·ª±c:</strong>
                <span class="text-secondary">{{ invoice.message }}</span>
            </p>
    </div>
    
    {% if invoice.common_name or invoice.valid_to %}
    <div class="panel-glass p-4 mb-3">
        <h6 class="mb-3">üßæ Th√¥ng tin Ch·ª©ng th∆∞ s·ªë</h6>
        <div class="row">
            <div class="col-md-6">
                <p class="mb-1"><strong>T√™n Chung (CN):</strong> <span class="text-primary">{{ invoice.common_name or 'N/A' }}</span></p>
                <p class="mb-1"><strong>T·ªï ch·ª©c (Org):</strong> <span>{{ invoice.organization or 'N/A' }}</span></p>
                <p class="mb-0"><strong>Qu·ªëc gia:</strong> <span>{{ invoice.country or 'N/A' }}</span></p>
            </div>
            <div class="col-md-6">
                <p class="mb-1"><strong>Hi·ªáu l·ª±c t·ª´:</strong> <span>{{ invoice.valid_from or 'N/A' }}</span></p>
                <p class="mb-1"><strong>Hi·ªáu l·ª±c ƒë·∫øn:</strong> <span class="text-danger fw-bold">{{ invoice.valid_to or 'N/A' }}</span></p>
                <p class="mb-0">**(L∆∞u √Ω: C√°c tr∆∞·ªùng T·ªï ch·ª©c/Qu·ªëc gia/Hi·ªáu l·ª±c t·ª´ ch·ªâ hi·ªÉn th·ªã n·∫øu ƒë∆∞·ª£c l∆∞u tr·ªØ ƒë·∫ßy ƒë·ªß trong DB)**</p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="panel-glass p-4 mb-3">
        <h6 class="mb-3">Chi ti·∫øt</h6>
        <div class="row">
            <div class="col-md-4">
                <h6 class="mb-0">HASHED DATA</h6>
                <textarea class="form-control" rows="10" readonly>{{ hashed }}</textarea>
            </div>
            <div class="col-md-4">
                <h6 class="mb-0">SIGNATURE</h6>
                <textarea class="form-control" rows="10" readonly>{{ signature }}</textarea>
            </div>
            <div class="col-md-4">
                <h6 class="mb-0">PUBLIC KEY</h6>
                <textarea class="form-control" rows="10" readonly>{{ cert }}</textarea>
            </div>
        </div>
    </div>

    <div class="panel-glass p-4 mt-3">
            <h6 class="mb-2">üìÅ Thao t√°c File & X√°c th·ª±c</h6>
            <div class="d-flex gap-3 mt-2">
                
                <a href="/download_pdf/{{ id }}" class="btn btn-danger btn-sm" download 
                title="T·∫°o v√† t·∫£i v·ªÅ file PDF">
                    <i class="bi bi-file-earmark-pdf"></i> T·∫£i v·ªÅ PDF
                </a>

                <a href="/invoices" class="btn btn-outline-primary btn-sm ms-auto">
                    <i class="bi bi-arrow-left"></i> Quay l·∫°i Danh s√°ch
                </a>
                
                </div>
    </div>

</div>

<div class="modal fade" id="xmlModal" tabindex="-1" aria-labelledby="xmlModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="xmlModalLabel">N·ªôi dung File XML ƒë√£ k√Ω (ID: {{ id }})</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <div id="loadingSpinner" class="text-center my-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">ƒêang t·∫£i n·ªôi dung XML...</p>
        </div>

        <pre id="xmlContentPre" style="display: none;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('viewXmlButton').addEventListener('click', function() {
    const modalElement = document.getElementById('xmlModal');
    const spinner = document.getElementById('loadingSpinner');
    const xmlContentPre = document.getElementById('xmlContentPre');
    const invoiceId = "{{ id }}";

    // Hi·ªán modal v√† spinner
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    spinner.style.display = 'block';
    xmlContentPre.style.display = 'none';
    xmlContentPre.textContent = ''; // X√≥a n·ªôi dung c≈©

    // Fetch n·ªôi dung XML t·ª´ route m·ªõi
    fetch(`/get_xml_content/${invoiceId}`)
        .then(response => {
            if (!response.ok) {
                // N·∫øu response l√† l·ªói, chuy·ªÉn sang text ƒë·ªÉ l·∫•y th√¥ng b√°o l·ªói
                return response.text().then(text => { throw new Error(text || 'L·ªói khi t·∫£i file XML.'); });
            }
            return response.text();
        })
        .then(xmlText => {
            // Ch√®n n·ªôi dung XML ƒë√£ t·∫£i v√†o th·∫ª <pre>
            xmlContentPre.textContent = xmlText;
            
            // ·∫®n spinner v√† hi·ªán n·ªôi dung
            spinner.style.display = 'none';
            xmlContentPre.style.display = 'block';
        })
        .catch(error => {
            xmlContentPre.textContent = 'Kh√¥ng th·ªÉ t·∫£i n·ªôi dung h√≥a ƒë∆°n: ' + error.message;
            spinner.style.display = 'none';
            xmlContentPre.style.display = 'block';
        });
});
    </script>

<script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.8.1/dist/vanilla-tilt.min.js"></script>
<script src="{{ url_for('static', filename='js/ui.js') }}"></script>

</body>
</html>