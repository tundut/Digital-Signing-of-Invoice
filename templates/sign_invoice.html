<!DOCTYPE html>
<html>
<head>
    <title>K√Ω s·ªë h√≥a ƒë∆°n XML</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/glass.css') }}">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            .nav-quiet.nav-strong{ gap:1rem; }
            .nav-quiet.nav-strong a{ font-weight:700; text-decoration:underline; color: var(--text); }
            .nav-quiet.nav-strong a:hover{ background: rgba(255,255,255,0.08); }
        </style>
</head>
<body class="glass d-flex align-items-center justify-content-center">
    <div id="transition-overlay"></div>
    <div class="container container-narrow py-4">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-10">
                                <div class="panel-glass p-4">
                                        <div class="text-center mb-3">
                                                <span class="accent-icon"><i class="bi bi-pencil-square"></i></span>
                                                <h4 class="title-quiet mt-2 mb-1">K√Ω s·ªë H√≥a ƒë∆°n XML</h4>
                        <p class="small subtle mb-0">T·∫£i l√™n h√≥a ƒë∆°n XML v√† ch·ª©ng th∆∞ s·ªë PFX ƒë·ªÉ k√Ω.</p>
                    </div>
                    <form id="signForm" action="/sign" method="post" enctype="multipart/form-data" class="mt-3">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">1. File h√≥a ƒë∆°n XML</label>
                            <input type="file" name="xml_file" id="xml_file" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">2. Ch·ª©ng th∆∞ s·ªë (PFX)</label>
                            <input type="file" name="pfx_file" id="pfx_file" class="form-control" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-semibold">3. M·∫≠t kh·∫©u PFX</label>
                            <input type="password" name="password" id="pfx_password" class="form-control" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn-glass btn-primary-glass" id="previewButton">Xem tr∆∞·ªõc & K√Ω</button>
                        </div>
                    </form>
                    <hr class="hr-faint">
                    <div class="text-center nav-quiet nav-strong">
                        <a href="/" title="Trang ch·ªß">Trang ch·ªß</a>
                        <a href="{{ url_for('list_invoices') }}" title="Danh s√°ch ƒë√£ k√Ω">Danh s√°ch ƒë√£ k√Ω</a>
                    </div>
                </div>
                        </div>
                </div>
        </div>
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="confirmModalLabel"><i class="bi bi-exclamation-triangle"></i> X√°c nh·∫≠n K√Ω s·ªë</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin tr∆∞·ªõc khi K√Ω s·ªë:</p>
            <div class="row mb-3">
                <div class="col-md-6 border-end">
                    <h5>üîë Ch·ª©ng th∆∞ s·ªë</h5>
                    <ul class="list-unstyled small">
                        <li><b>CN:</b> <span id="certCn"></span></li>
                        <li><b>Org:</b> <span id="certOrg"></span></li>
                        <li><b>H·∫°n d√πng:</b> <span class="text-danger" id="certValidTo"></span></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>üìÑ H√≥a ƒë∆°n</h5>
                    <ul class="list-unstyled small">
                        <li><b>S·ªë Hƒê:</b> <span id="invNumber"></span></li>
                        <li><b>Ng√†y:</b> <span id="invDate"></span></li>
                        <li><b>T·ªïng ti·ªÅn:</b> <span class="text-primary fw-bold" id="invTotal"></span></li>
                    </ul>
                </div>
            </div>
            <div class="alert alert-danger mt-3 small">Sau khi k√Ω, c·∫•u tr√∫c file XML s·∫Ω thay ƒë·ªïi. H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</div>
            <div class="row g-2">
                <div class="col-md-6">
                    <textarea class="form-control" rows="8" id="pubkey" readonly></textarea>
                </div>
                <div class="col-md-6">
                    <textarea class="form-control" rows="8" id="privatekey" readonly></textarea>
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-primary" id="finalSignButton">X√°c nh·∫≠n & K√Ω s·ªë</button>
          </div>
        </div>
      </div>
    </div>
<script>
// Gi·ªØ logic xem tr∆∞·ªõc & k√Ω t·ª´ phi√™n b·∫£n g·ªëc
document.getElementById('signForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const previewButton = document.getElementById('previewButton');
    const finalSignButton = document.getElementById('finalSignButton');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    if (!document.getElementById('xml_file').files.length || !document.getElementById('pfx_file').files.length) {
        alert('Vui l√≤ng ch·ªçn file XML v√† PFX.');
        return;
    }
    previewButton.disabled = true; previewButton.textContent = 'ƒêang xem tr∆∞·ªõc...';
    fetch('/preview_sign', { method:'POST', body: formData })
      .then(r => { if(!r.ok) return r.json().then(err=>{throw new Error(err.message||'L·ªói');}); return r.json(); })
      .then(data => {
        if(data.status==='success') {
            document.getElementById('certCn').textContent = data.cert.common_name;
            document.getElementById('certOrg').textContent = data.cert.organization;
            document.getElementById('certValidTo').textContent = data.cert.valid_to;
            document.getElementById('invNumber').textContent = data.invoice.number;
            document.getElementById('invDate').textContent = data.invoice.date;
            document.getElementById('invTotal').textContent = data.invoice.total;
            document.getElementById('pubkey').value = data.pubkey;
            document.getElementById('privatekey').value = data.privatekey;
            confirmModal.show();
        } else { alert('L·ªói: '+data.message); }
      })
      .catch(err => alert('L·ªói xem tr∆∞·ªõc: '+ err.message))
      .finally(()=>{ previewButton.disabled=false; previewButton.textContent='Xem tr∆∞·ªõc & K√Ω'; });

    finalSignButton.onclick = function(){ confirmModal.hide(); form.submit(); };
});
</script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.8.1/dist/vanilla-tilt.min.js"></script>
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
</body>
</html>