<!DOCTYPE html>
<html>
<head>
    <title>X√°c th·ª±c ch·ªØ k√Ω ‚Ä¢ Cyber</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/glass.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* CSS ƒë·ªÉ s·ª≠a l·ªói b·∫£ng */
        .table th:nth-child(1) { width: 18%; } /* ID */
        .table th:nth-child(2) { width: 18%; } /* CN */
        .table th:nth-child(3) { width: 15%; } /* H·∫°n d√πng */
        .table th:nth-child(4) { width: 10%; } /* Status K√Ω */
        .table th:nth-child(5) { width: 12%; } /* Status X√°c th·ª±c */
        .table th:nth-child(6) { width: 10%; } /* H√†nh ƒë·ªông */
        pre { max-height: 150px; overflow-y: auto; font-size: 0.8em; }
        /* Match generator nav style */
        .nav-quiet.nav-strong{ gap:1rem; }
        .nav-quiet.nav-strong a{ font-weight:700; text-decoration:underline; color: var(--text); }
        .nav-quiet.nav-strong a:hover{ background: rgba(255,255,255,0.08); }
        /* Modal content clarity */
        dl.row dt{ font-weight:700; }
        dl.row dd{ margin-bottom:.5rem; }
        /* Stronger, non-blurry modal for verification */
        #invoiceDetailModal .modal-content{ 
            backdrop-filter: none !important; 
            -webkit-backdrop-filter: none !important; 
            background: rgba(20,22,26,0.98) !important; 
            border: 1px solid rgba(255,255,255,0.22) !important; 
            box-shadow: 0 18px 48px rgba(0,0,0,0.6);
            color: #f4f6f8;
        }
        #invoiceDetailModal .modal-header{ border-bottom-color: rgba(255,255,255,0.18); }
        #invoiceDetailModal .modal-footer{ border-top-color: rgba(255,255,255,0.18); }
        /* Solid panels inside modal */
        .panel-solid{
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: .75rem;
        }
    </style>
</head>

<body class="glass p-4">

<div class="container">
    <div class="text-center mb-4">
        <h4 class="title-quiet mb-3">üõ°Ô∏è X√°c th·ª±c Ch·ªØ k√Ω H√≥a ƒë∆°n</h4>
    </div>

    <div class="panel-glass p-3">
            <table class="table table-hover align-middle table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>ID h√≥a ƒë∆°n</th>
                        <th>T√™n Ch·ª©ng ch·ªâ (CN)</th>
                        <th>H·∫°n d√πng</th>
                        <th class="text-center">Tr·∫°ng th√°i K√Ω</th>
                        <th class="text-center">Tr·∫°ng th√°i X√°c th·ª±c</th>
                        <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>

                <tbody>
                {% for id, inv in invoices.items() %}
                    <tr>
                        <td class="text-break small">{{ id[:8] }}...</td>
                        <td class="small">{{ inv.common_name or 'N/A' }}</td>
                        <td class="small">{{ inv.valid_to or 'N/A' }}</td>
    <div id="transition-overlay"></div>
                        
                        <td class="text-center">
                            {% if inv.status == "valid" %}
                                <span class="badge bg-success py-2">H·ª£p l·ªá</span>
                            {% else %}
                                <span class="badge bg-danger py-2">Kh√¥ng h·ª£p l·ªá</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            {% if inv.verification_status == "VERIFIED" %}
                                <span class="badge bg-success py-2">ƒê√£ X√°c th·ª±c</span>
                            {% elif inv.verification_status == "PENDING" %}
                                <span class="badge bg-warning text-dark py-2">ƒêang Ch·ªù</span>
                            {% else %}
                                <span class="badge bg-danger py-2">T·ª´ ch·ªëi</span>
                            {% endif %}
                        </td>
                        
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-info text-white view-detail-btn" 
                               data-id="{{ id }}">
                                X√°c th·ª±c
                            </button>
                        </td>
                    </tr>
                {% endfor %}
                {% if not invoices %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o trong danh s√°ch.</td>
                    </tr>
                {% endif %}
                </tbody>
            </table>
    </div>
    
    <div class="text-center nav-quiet nav-strong mt-4">
        <a href="{{ url_for('list_invoices') }}">Danh s√°ch ƒë√£ k√Ω</a>
        <a href="/">Trang ch·ªß</a>
    </div>
</div>

<div class="modal fade" id="invoiceDetailModal" tabindex="-1" aria-labelledby="invoiceDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceDetailModalLabel">Chi ti·∫øt H√≥a ƒë∆°n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <div id="modalContentContainer">
                    <div class="text-center my-5"><div class="spinner-border text-primary" role="status"></div><p>ƒêang t·∫£i chi ti·∫øt...</p></div>
                </div>
            </div>
            
            <div class="modal-footer d-block">
                
                <h5 class="mt-4 mb-3">Thao t√°c X·ª≠ l√Ω</h5>
                
                <div id="verificationActions" class="d-flex justify-content-end gap-2">
                    
                    <a id="downloadPdfLink" href="#" target="_blank" class="btn btn-danger"><i class="bi bi-file-earmark-pdf"></i> T·∫£i PDF</a>
                    
                    <form id="approveForm" method="POST" class="d-inline">
                        <input type="hidden" name="action" value="APPROVE">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> X√°c nh·∫≠n H·ª£p l·ªá
                        </button>
                    </form>
                    
                </div>
                
                <div class="mt-3 border-top pt-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
            </div>
    </div>
</div>

<script>
let currentInvoiceId = null;

document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('invoiceDetailModal');
    const modal = new bootstrap.Modal(modalElement);
    const container = document.getElementById('modalContentContainer');
    const downloadPdfLink = document.getElementById('downloadPdfLink');
    const approveForm = document.getElementById('approveForm');

    // S·ª± ki·ªán m·ªü Modal
    document.querySelectorAll('.view-detail-btn').forEach(button => {
        button.addEventListener('click', function() {
            const invoiceId = this.dataset.id;
            currentInvoiceId = invoiceId;
            
            // 1. Reset Modal v√† hi·ªÉn th·ªã loading
            container.innerHTML = '<div class="text-center my-5"><div class="spinner-border text-primary" role="status"></div><p>ƒêang t·∫£i chi ti·∫øt...</p></div>';
            modal.show();
            
            // 2. C·∫≠p nh·∫≠t Action Forms v√† Links
            approveForm.action = `/confirm_verify/${invoiceId}`;
            downloadPdfLink.href = `/download_pdf/${invoiceId}`;
            
            // 3. Fetch d·ªØ li·ªáu
            fetch(`/api/invoice_detail/${invoiceId}`)
                .then(response => {
                    // N·∫øu kh√¥ng ph·∫£i l√† JSON (do l·ªói), ta chuy·ªÉn th√†nh text ƒë·ªÉ xem n·ªôi dung
                    if (!response.headers.get('content-type').includes('application/json')) {
                        return response.text().then(text => {
                            throw new Error("Server tr·∫£ v·ªÅ HTML/L·ªói: " + text.substring(0, 500) + "...");
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const inv = data.invoice;
                        
                        // 4. X√¢y d·ª±ng n·ªôi dung chi ti·∫øt
                        let statusBadge = inv.status === 'valid' ? 
                            '<span class="badge bg-success">H·ª£p l·ªá</span>' : 
                            '<span class="badge bg-danger">Kh√¥ng h·ª£p l·ªá</span>';
                            
                        let verificationBadge = '';
                        let verificationNote = inv.verification_message || 'Ch∆∞a c√≥ th√¥ng b√°o chi ti·∫øt.';

                        if (inv.verification_status === 'PENDING') {
                            verificationBadge = '<span class="badge bg-warning text-dark">ƒêang Ch·ªù X·ª≠ L√Ω</span>';
                        } else if (inv.verification_status === 'VERIFIED') {
                            verificationBadge = '<span class="badge bg-success">ƒê√£ X√°c th·ª±c</span>';
                        } else {
                            verificationBadge = '<span class="badge bg-danger">ƒê√£ T·ª´ ch·ªëi</span>';
                        }
                        
                        // 5. Ch√®n n·ªôi dung v√†o container (giao di·ªán r√µ r√†ng h∆°n)
                        container.innerHTML = `
                            <div class="mb-3">
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <h5 class="mb-0">K·∫øt qu·∫£ x√°c th·ª±c</h5>
                                    ${verificationBadge}
                                    <span class="ms-auto small text-muted">ID: <code>${inv.id}</code></span>
                                </div>
                                <div class="small mt-1">Tr·∫°ng th√°i k√Ω: ${statusBadge}</div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="panel-solid p-3 h-100">
                                        <div class="fw-semibold mb-2">Th√¥ng b√°o h·ªá th·ªëng</div>
                                        <div class="mb-2">${inv.message || 'Kh√¥ng c√≥ th√¥ng b√°o.'}</div>
                                        <div class="text-muted small">Ghi ch√∫ x·ª≠ l√Ω:</div>
                                        <div>${verificationNote}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="panel-solid p-3 h-100">
                                        <div class="fw-semibold mb-2">Th√¥ng tin ch·ª©ng th∆∞</div>
                                        <dl class="row mb-0">
                                            <dt class="col-4">CN</dt><dd class="col-8">${inv.common_name || 'N/A'}</dd>
                                            <dt class="col-4">T·ªï ch·ª©c</dt><dd class="col-8">${inv.organization || 'N/A'}</dd>
                                            <dt class="col-4">Hi·ªáu l·ª±c ƒë·∫øn</dt><dd class="col-8"><span class="text-danger">${inv.valid_to || 'N/A'}</span></dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 d-flex gap-2">
                                <a href="/download_xml/${inv.id}" class="btn btn-sm btn-outline-info">T·∫£i XML ƒë√£ k√Ω</a>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="reloadModalContent()">Ki·ªÉm tra l·∫°i</button>
                            </div>
                        `;

                        // 6. Hi·ªÉn th·ªã/·∫®n c√°c n√∫t h√†nh ƒë·ªông (Ch·∫•p thu·∫≠n/T·ª´ ch·ªëi)
                        document.getElementById('verificationActions').style.display = inv.verification_status === 'PENDING' ? 'flex' : 'none';

                    } else {
                        container.innerHTML = '<div class="alert alert-danger">L·ªói: Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt h√≥a ƒë∆°n.</div>';
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu: ${error}</div>`;
                });
        });
    });
});

function reloadModalContent() {
    if (currentInvoiceId) {
        // T√°i s·ª≠ d·ª•ng logic Fetch ƒë·ªÉ t·∫£i l·∫°i n·ªôi dung
        const container = document.getElementById('modalContentContainer');
        const downloadPdfLink = document.getElementById('downloadPdfLink'); // V√≠ d·ª•: C·∫ßn c·∫≠p nh·∫≠t c√°c bi·∫øn n√†y

        container.innerHTML = '<div class="text-center my-5"><div class="spinner-border text-primary" role="status"></div><p>ƒêang ki·ªÉm tra l·∫°i ch·ªØ k√Ω...</p></div>';

        fetch(`/api/invoice_detail/${currentInvoiceId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // C·∫¨P NH·∫¨T: T√°i t·∫°o n·ªôi dung chi ti·∫øt
                    // (B·∫°n c·∫ßn sao ch√©p logic x√¢y d·ª±ng container.innerHTML t·ª´ ph·∫ßn .then() ·ªü tr√™n)
                    const inv = data.invoice;
                    
                    // V√≠ d·ª• (b·∫°n c·∫ßn ƒë∆∞a logic x√¢y d·ª±ng container.innerHTML c·ªßa b·∫°n v√†o ƒë√¢y):
                    container.innerHTML = `
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h5>üìù Tr·∫°ng th√°i K√Ω s·ªë</h5>
                                <p><strong>K·∫øt qu·∫£ K√Ω:</strong> ${inv.status === 'valid' ? '<span class="badge bg-success">H·ª£p l·ªá</span>' : '<span class="badge bg-danger">Kh√¥ng h·ª£p l·ªá</span>'}</p>
                                <p><strong>Th√¥ng b√°o K√Ω:</strong> ${inv.message}</p>
                            </div>
                            </div>
                    `;
                    
                    // C·∫≠p nh·∫≠t c√°c forms v√† link (nh∆∞ trong h√†m click ban ƒë·∫ßu)
                    document.getElementById('approveForm').action = `/confirm_verify/${currentInvoiceId}`;
                    // ... c√°c forms kh√°c ...
                    document.getElementById('verificationActions').style.display = inv.verification_status === 'PENDING' ? 'flex' : 'none';
                    
                } else {
                    container.innerHTML = '<div class="alert alert-danger">L·ªói: Kh√¥ng th·ªÉ ki·ªÉm tra l·∫°i.</div>';
                }
            })
            .catch(error => {
                container.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi khi ki·ªÉm tra l·∫°i: ${error}</div>`;
            });
    }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.8.1/dist/vanilla-tilt.min.js"></script>
<script src="{{ url_for('static', filename='js/ui.js') }}"></script>
</body>
</html>