<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hóa đơn PDF - {{ id }}</title>
    <style>
        /* * KHỐI CSS QUAN TRỌNG ĐÃ SỬA ĐỔI
         * Đảm bảo font được nhúng HOẶC dùng font hệ thống 
         */
        {% if font_uri %}
        /* 1. Định nghĩa font VNFont nếu đường dẫn font được cung cấp */
        @font-face {
            font-family: 'VNFont';
            src: url('{{ font_uri }}') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'VNFont';
            src: url('{{ font_bold_uri or font_uri }}') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        /* Sử dụng VNFont làm font chính, sau đó đến Arial/sans-serif để dự phòng */
        body { font-family: 'VNFont', Arial, sans-serif; margin: 50px; }
        {% else %}
        /* 2. Nếu font_uri không được cung cấp, dùng font hệ thống hỗ trợ tiếng Việt (Arial) */
        /* Đây là cách khắc phục tạm thời nếu việc nhúng font bị lỗi */
        body { font-family: Arial, sans-serif; margin: 50px; }
        {% endif %}

        /* Các quy tắc CSS còn lại được giữ nguyên */
        .invoice-box {
            max-width: 800px;
            margin: auto;
            padding: 30px;
            border: 1px solid #eee;
            box-shadow: none;
            font-size: 14px;
            line-height: 24px;
            color: #555;
        }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #3498db; margin-bottom: 5px; }
        .details, .total { margin-top: 20px; }
        table { width: 100%; line-height: inherit; text-align: left; border-collapse: collapse; }
        table td, table th { padding: 8px; vertical-align: top; border: 1px solid #ddd; }
        .seller, .buyer { width: 50%; float: left; }
        .status-box { background-color: #e6f7ff; padding: 10px; border-left: 5px solid #3498db; }
    </style>
</head>
<body>

<div class="invoice-box">
    <div class="header">
        <h1>HÓA ĐƠN ĐIỆN TỬ</h1>
        <p>Số: {{ xml_tree.findtext("InvoiceNumber") }} | Ngày: {{ xml_tree.findtext("IssueDate") }}</p>
    </div>

    <div class="status-box">
        Trạng thái xác thực: <strong>{{ invoice.verification_status }}</strong> (Tải PDF kích hoạt xác thực)
    </div>

    <div class="details clearfix">
        <div class="seller">
            <strong>Bên Bán (Seller)</strong><br>
            Tên: {{ xml_tree.findtext("Seller/Name") }}<br>
            MST: {{ xml_tree.findtext("Seller/TaxCode") }}<br>
            Địa chỉ: {{ xml_tree.findtext("Seller/Address") }}
        </div>
        <div class="buyer">
            <strong>Bên Mua (Buyer)</strong><br>
            Tên: {{ xml_tree.findtext("Buyer/Name") }}<br>
            MST: {{ xml_tree.findtext("Buyer/TaxCode") }}<br>
            Địa chỉ: {{ xml_tree.findtext("Buyer/Address") }}
        </div>
    </div>

    <table class="items">
        <thead>
            <tr class="heading">
                <th>Mô tả</th>
                <th style="width: 10%">SL</th>
                <th style="width: 20%; text-align: right;">Đơn giá</th>
                <th style="width: 20%; text-align: right;">Thành tiền</th>
            </tr>
        </thead>
        <tbody>
            {% for item in xml_tree.xpath('//Item') %}
            <tr class="item">
                <td>{{ item.findtext("Description") }}</td>
                <td>{{ item.findtext("Quantity") }}</td>
                <td style="text-align: right;">{{ item.findtext("UnitPrice") }}</td>
                <td style="text-align: right;">{{ item.findtext("Amount") }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="total">
        Tổng cộng: <strong>{{ xml_tree.findtext("TotalAmount") }} VND</strong>
    </div>
    
    <div style="margin-top: 50px;">
        Chữ ký số được xác nhận bởi hệ thống vào: {{ invoice.created_at }}<br>
        Chứng chỉ: {{ invoice.common_name }} (Hạn: {{ invoice.valid_to }})
    </div>
</div>

</body>
</html>